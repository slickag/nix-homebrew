name: Update Flake Lock

on:
  workflow_dispatch:
  schedule:
    - cron: '25 */8 * * *'

jobs:
  update-flake:
    runs-on: macos-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
        with:
          ref: ${{ (github.event_name == 'workflow_dispatch' && github.ref_name) || 'brew-latest-patch-1' }}

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v21

      - name: Check For Updates
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CURRENT_COMMIT=$(perl -nle 'print $1 if /"rev": "([\d\D]+)",/' flake.lock)
          echo "Current commit: $CURRENT_COMMIT"
          echo "current_commit=$CURRENT_COMMIT" >> $GITHUB_OUTPUT

          LATEST_COMMIT=$(gh api repos/Homebrew/brew/branches/main --jq .commit.sha)
          echo "Latest commit: $LATEST_COMMIT"

          if [ -z "$LATEST_COMMIT" ] || [ "$LATEST_COMMIT" = "null" ]; then
            echo "Error: Failed to fetch latest commit from GitHub API."
            gh api repos/Homebrew/brew/branches/main || true
            exit 1
          fi

          if [ "$CURRENT_COMMIT" = "$LATEST_COMMIT" ]; then
            echo "Already up to date."
            echo "updated=false" >> $GITHUB_OUTPUT
          else
            echo "New commit detected: $LATEST_COMMIT"
            echo "updated=true" >> $GITHUB_OUTPUT
            echo "latest_commit=$LATEST_COMMIT" >> $GITHUB_OUTPUT
          fi

      - name: Set Up Cache
        if: steps.check.outputs.updated == 'true'
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Update Flake & Files
        id: updates
        if: steps.check.outputs.updated == 'true'
        run: |
          nix flake lock --update-input brew-src

          nix develop --command bash scripts/update-brew-tail.sh

          UPDATE_TIME=$(date '+%Y-%m-%d %H:%M:%S')
          echo "update_time=$UPDATE_TIME" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        id: cpr
        if: steps.check.outputs.updated == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "brew-src: ${{ steps.check.outputs.current_commit }} -> ${{ steps.check.outputs.latest_commit }}"
          branch: "update-flake-${{ steps.check.outputs.latest_commit }}"
          delete-branch: true
          title: "brew-src: ${{ steps.check.outputs.current_commit }} -> ${{ steps.check.outputs.latest_commit }}"
          body: |
            Automated update of flake.lock

            - **Current Commit**: `${{ steps.check.outputs.current_commit }}`
            - **New Commit**: `${{ steps.check.outputs.latest_commit }}`

            Auto-generated by `update-flake.yaml` workflow on `${{ steps.updates.outputs.update_time }}`
          labels: dependencies, automated pr

      - name: Enable Pull Request Automerge
        if: steps.cpr.outputs.pull-request-operation == 'created'
        run: gh pr merge --squash "${{ steps.cpr.outputs.pull-request-number }}"
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN_FOR_UPDATES }}
