name: Update Flake Lock

on:
  workflow_dispatch:
  schedule:
    - cron: '25 */8 * * *'

defaults:
  run:
    shell: bash -xeuo pipefail {0}

jobs:
  update-flake:
    runs-on: macos-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
        with:
          ref: ${{ (github.event_name == 'workflow_dispatch' && github.ref_name) || 'brew-latest-patch-1' }}

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v21

      - name: Check For Updates
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CURRENT_VERSION=$(perl -nle 'print $1 if /github:Homebrew\/brew\/([0-9.]+)/' flake.nix)
          echo "Current version: $CURRENT_VERSION"
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

          LATEST_VERSION=$(gh api repos/Homebrew/brew/releases/latest --jq .tag_name)
          echo "Latest version: $LATEST_VERSION"

          if [ -z "$LATEST_VERSION" ] || [ "$LATEST_VERSION" = "null" ]; then
            echo "Error: Failed to fetch latest version from GitHub API."
            gh api repos/Homebrew/brew/releases/latest || true
            exit 1
          fi

          if [ "$CURRENT_VERSION" = "$LATEST_VERSION" ]; then
            echo "Already up to date."
            echo "updated=false" >> $GITHUB_OUTPUT
          else
            echo "New version detected: $LATEST_VERSION"
            echo "updated=true" >> $GITHUB_OUTPUT
            echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Set Up Cache
        if: steps.check.outputs.updated == 'true'
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Update Flake & Files
        if: steps.check.outputs.updated == 'true'
        run: |
          NEW_VERSION="${{ steps.check.outputs.latest_version }}"

          perl -pi -e "s|github:Homebrew/brew/[0-9.]+|github:Homebrew/brew/$NEW_VERSION|" flake.nix

          nix flake lock --update-input brew-src

          nix develop --command bash scripts/update-brew-tail.sh

      - name: Create Pull Request
        id: cpr
        if: steps.check.outputs.updated == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "brew-src: ${{ steps.check.outputs.current_version }} -> ${{ steps.check.outputs.latest_version }}"
          branch: "update-homebrew-${{ steps.check.outputs.latest_version }}"
          delete-branch: true
          title: "brew-src: ${{ steps.check.outputs.current_version }} -> ${{ steps.check.outputs.latest_version }}"
          body: |
            Automated update of Homebrew version.

            - **Current Version**: `${{ steps.check.outputs.current_version }}`
            - **New Version**: `${{ steps.check.outputs.latest_version }}`

            Auto-generated by `update-flake.yaml` workflow on $(date '+%Y-%m-%d %H:%M:%S')
          labels: dependencies, automated pr

      - name: Enable Pull Request Automerge
        if: steps.cpr.outputs.pull-request-operation == 'created'
        run: gh pr merge --squash "${{ steps.cpr.outputs.pull-request-number }}"
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN_FOR_UPDATES }}
